layout: post
title: "POST TITLE"
date: YYYY-MM-DD hh:mm:ss -0000
categories: https 

背景说明
本文是我花费约6小时时间，查阅多种资料，最后整理出我对HTTPS的理解。本文会回答以下几个问题：
HTTPS 是如何对数据包进行加密的？
SSL证书是为了解决什么问题？没有它行不行
公司能监控到员工浏览了哪些网站吗？
既然HTTPS数据包无法被窃听，那么charles（抓包工具）是怎么做到“对https请求进行抓包”的？
HTTPS是什么 & HTTP原理
HTTPS是什么？加密原理和证书。SSL/TLS握手过程_哔哩哔哩_bilibili 
如果你还不了解HTTPS通信过程，建议看一下上面这个视频，再进行本文后续的阅读。
我从这个视频中，学到了以下知识点：
1、TSL握手过程中，服务端会把CA证书发送给客户端。
​

编辑

切换为居中
利用openssl命令，生成的自签名证书
证书关键信息如下：
证书绑定的域名
公钥
签名。
2、浏览器会对证书进行以下几个方面的校验：
（1）证书是否是可信任证书。
（2）证书是否被篡改。 https://www.zhihu.com/question/37370216/answer/1914075935
我们在做后端api开发时，经常会在参数中加一个签名（sign参数），假如我们的签名算法是：
md5(implode(',', $query_params) . $secretKey)
签名算法只有通信双方知道。如果中间人篡改url中的参数，服务端就能识别出签名不合法，利用这种方式就可以防止url被非法篡改。
猜测证书的防篡改校验也是类似的。利用证书中的签名，来判断证书内容是否被篡改。
参考链接，文中对 “对于由证书官方机构颁发的证书，浏览器是如何验证证书的合法性”  做了详细的阐述。
简单来说，分两步：
CA 签发证书时，会用自己的私钥，对证书内容进行加密，生成证书中的数字签名。
浏览器收到证书后，会利用CA的公钥（通常浏览器和操作系统中集成了 CA 的公钥信息），对数字签名进行解密。
（3）访问的域名，和证书绑定的域名是否匹配。如果不匹配，是不允许访问的。
3、TSL实现tcp数据包加密的过程，大致如下：
（1）在TSL握手阶段，服务端保留私钥，同时把公钥发送给客户端，最终双方经过协商，会用公钥加密生成一个双方认同的会话密匙。 （此处是非对称加密）
​

编辑

切换为居中
添加图片注释，不超过 140 字（可选）
这一步，客户端和服务端协商好加密算法、加密密钥。密钥如果明文传输就可能被窃听，因此要用SSL证书中的公钥对会话密钥进行加密。
（2）后面数据包的加密，会用会话密匙作为密钥，对数据包进行对称加密。 （之所以这样，是因为非对称加密性能低）
4、HTTPS能防止网络包被中间人（如网络运营商、提供WIFI服务商家）窃听、篡改、冒充，保证信息安全。
15年前，记得大多数网站还不支持https，那时候我们访问一个网站，经常运营商会篡改html，在其中插入一些js等，用来展示广告。现在正常是没法篡改的。
SSL证书（Certificate）是什么
证书是权威 CA 中心对特定公钥信息的一种公证载体，也可以理解为是权威 CA 对特定公钥未被篡改的签名背书。由于客户的机器上已经预置了这些权威 CA 中心本身的证书（称为 CA 证书或者根证书），使得我们能够在不依靠网络的前提下，使用根证书里面的公钥信息对其所签发的证书中的签名进行确认。到此，终于打破了鸡生蛋、蛋生鸡的循环，使得整套数字签名体系有了坚实的逻辑基础。 
以上信息来源于：传输 | 凤凰架构
为了帮助理解，我先在本地用nginx搭建一个https server。
（1）生成SSL证书
# 生成ssl证书，存入文件certificate.pem。
# 在生成证书的过程中，会自动生成一个私钥，存放在文件privkey.pem中
openssl req -newkey rsa:2048 -nodes -keyout privkey.pem -x509 -days 365 -out certificate.pem
# 注意： 生成证书的过程中，需要输入证书绑定的域名。后续未绑定的域名，是不可以使用这个证书的。
执行上面的命令，会生成下面两个文件：
​

编辑

切换为居中
添加图片注释，不超过 140 字（可选）
（2）nginx配置：
server {
    listen 443 ssl;
    server_name albin.com;
    ssl_certificate /Users/xushengbin/code/ssl/certificate.pem;
    ssl_certificate_key /Users/xushengbin/code/ssl/privkey.pem;
}
证书中存放的是公钥。此时，公钥、私钥都已经存在在服务器上了
（3）修改/etc/hosts文件：
127.0.0.1 albin.com
（4）用chrome访问 https://albin.com
​

编辑

切换为居中
添加图片注释，不超过 140 字（可选）
无法访问。
用curl命令debug一下：
​

编辑

切换为居中
添加图片注释，不超过 140 字（可选）
TLSv1.2 (IN), TLS handshake, Certificate (11)
意思是，TLS握手过程中，服务端把证书发送了客户端（浏览器）
* TLSv1.2 (OUT), TLS alert, unknown CA (560)
客户端对证书进行验证，结果是未知的证书。
“curl failed to verify the legitimacy of the server and therefore could not establish a secure connection to it“，客户端断开了链接。
特别说明：此时，通过以下命令，禁用证书校验，也是可以正常请求的：
wget 'https://albin.com' --no-check-certificate
这也说明了，为了保证网络安全，仅有服务端提供https支持是不够的，用户还必须使用安全的浏览器。
（5）我们需要把证书加入信任证书列表
​

编辑

切换为居中
添加图片注释，不超过 140 字（可选）
这个证书就是TSL握手过程中，服务端发送给客户端的证书。拖动上面的图标，把证书保存到本地文件夹，然后双击：
​

编辑

切换为居中
添加图片注释，不超过 140 字（可选）
此时，再重新测试：
用curl可以正常访问。
用chrome：
​

编辑

切换为居中
添加图片注释，不超过 140 字（可选）
可以正常访问，但是还是提示不安全，也许是因为我们这个证书，不是官方机构颁发的，即使我已经信任了这个证书，chrome还是贴心地做了这个安全提示。
查了一下chrome的安全策略（什么是自签名证书？自签名SSL证书的优缺点? - SegmentFault 思否）：
由于我们的证书是自签名证书（Self-Signed，自签名证书是由不受信的CA机构颁发的数字证书，也就是自己签发的证书），每当用户访问使用自签名证书的站点时，他们会收到“不安全”警告。
前面提到过，证书是和域名绑定的。针对这一点做一下验证：
​

编辑

切换为居中
添加图片注释，不超过 140 字（可选）
访问“https://127.0.0.1/”， 提示域名不匹配。

为什么要有SSL证书？
SSL证书弄的挺麻烦的，没有他行不行？
如果没有SSL证书，会出现这样的情况：
用户请求网站A，A返回了公钥，此时，中间人（如电信运营商），就可以截留这个公钥1，然后中间人用自己生成的公钥2发送给浏览器，中间人收到浏览器请求以后，就可以用公钥2对应的私钥进行解密，然后进行篡改，再利用公钥1和网站A进行交互。
此时，中间人就可以窃听、篡改网络包。
有了SSL证书以后，中间人如果要想窃听网络包，就必须得把自己的证书发送给浏览器，此时这个证书要么不是官方机构签发的，要么证书绑定的域名和网站A不匹配，总之浏览器能识别出来这是不合法的证书，从而达到防止窃听篡改的目的。
因此，证书不可篡改就特别重要：证书的签名，必须用CA的私钥才能解密，解密以后，就是证书内容的hash值。如果内容被篡改，hash值就不一致了。
另外，SSL证书中包含了组织的名称、地址、服务器DNS。每个证书都是由某些证书颁发机构（CA）签发的，它们负责为服务器担保。证书有不同的等级，每种证书都要求不同级别的背景验证。比如，如果申请某个电子商务服务器证书，通常需要提供一个营业的合法证明。
有了SSL证书，浏览器就可以告诉用户，你是在和一个可靠的服务提供商进行通信（证明服务提供方的身份），并且通信内容是安全的（不可被窃听、篡改）。
​

编辑

切换为居中
添加图片注释，不超过 140 字（可选）
​

编辑

切换为居中
添加图片注释，不超过 140 字（可选）
charles HTTPS 抓包的原理是什么？
参考 使用Charles进行HTTPS抓包 - 掘金， 了解如何用charles进行https抓包。 
前面提到，HTTPS能防止网络包被中间人（这里就是charles）窃听，那么，charles中却能查看https数据包原文，是怎么做到的呢？
参考：浅谈Charles抓取HTTPS原理及HTTP CONNECT ， 建议细看。
看完之后，说下个人理解：
安装charles，并开启"macos proxy”，代理的地址是127.0.0.1:8888。
我们使用charles时，会把charles作为浏览器的代理，所有的请求都先到达charles。
为了说明代理的原理，我们用curl通过代理，请求baidu
curl --proxy 'http://127.0.0.1:8888' 'https://www.baidu.com?a=1'

添加图片注释，不超过 140 字（可选）
此时，charles无法看到HTTP中的数据包：只能看到请求的域名是www.baidu.com，无法看到请求的参数。
如果想了解HTTPS代理原理，可参考：
HTTP 隧道代理原理和实现 | Cizixs Write Here 
什么是HTTP隧道，怎么理解HTTP隧道呢？
说明：理解HTTP隧道，是理解HTTPS代理的关键。
此时charles只是转发浏览器和baidu服务器的加密数据包，无法看到数据包内容。

charles如果想看到数据包的内容，就需要用户把charles颁发的一个证书，加入系统信任认证列表。
此时最关键的一个变化：浏览器和charlse通信时，返回的是的charles颁发的证书，那么，charles就可以利用自己掌握的私钥，对数据进行解密。解密之后，charles拿到原始的https请求，再代替浏览器和baidu服务器进行HTTPS通信。
​

编辑

切换为居中
添加图片注释，不超过 140 字（可选）
可以看到，此时，访问baidu，浏览器收到的证书，是由Charles签发的证书，并非官方机构，因此在配置charles https代理时，需要把Charles跟证书，手动加入信任证书列表。
说明：我前面用nginx做测试时，用的是自签名证书，浏览器会提示请求不安全。但是这里的证书，并非自签名证书（而是由charles签发的），在手动信任了根证书之后，浏览器不会提示请求不安全。
公司网络监控，能监控到HTTPS请求吗？
经过前面的分析，可以确定，公司看不到HTTPS请求的包体，但是tcp连接的目的ip却是明文的，公司一定知道你访问了哪个服务器（比如boss直聘的服务器），以及访问了多少次。
我家的华为路由器后台，可以设置屏蔽哪些域名。 那么说明公司的路由器肯定是能知道员工访问了哪些网站（只有知道了，才能做屏蔽）
​

编辑

切换为居中
添加图片注释，不超过 140 字（可选）
最后，公司是怎么知道某一个网络请求是哪个员工访问的呢？
一个tcp数据包，从网络层进入数据链路层时，会把源ip、目的ip，分布转换为源mac地址、下一跳路由器的mac地址。源mac地址就是用户电脑的mac地址，不同电脑的mac地址是唯一的。
这样，公司就知道哪个员工在访问boss直聘了，但是却不知道你在boss直聘上干了啥（是否投简历等）。
极端情况下，如果公司很过分，就跟我们前面讲的charles HTTPS代理的例子一样，公司如果给所有员工电脑安装了自有证书，并且统一设置了网络代理，理论上就能监控到你在某个网站干了啥（给哪个公司投了简历）。
总结
如果你想更系统理解https，建议阅读《HTTP权威指南》第14章：安全HTTP
HTTP权威指南-David Gourley Brian Totty等-微信读书 